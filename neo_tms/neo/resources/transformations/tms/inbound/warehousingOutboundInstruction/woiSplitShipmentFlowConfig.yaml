 #remove mitcc flow
- sourceModel: warehousingOutboundInstruction
  targetModel: process_shipment_update_remove_mitcc
  modelMapping:

    fieldVariableMapping:
      - variableName: enrichment
        variableValue: enrichment
      - variableName: filtered_shipment_items
        operations:
          - customFunction:
              functionName: get_filtered_shipment_items_for_mitcc
              fields: [ field: warehousingOutboundInstruction.shipment, field: global_variable.enrichment.shipment ]
    segmentMapping:
      - targetSegment: payload
        sourceSegment: global_variable.filtered_shipment_items

        fieldMapping:
          - targetField: ignoreAllShipmentReferenceNumbersFlag
            default: true
          - targetField: ignoreAllThroughPointsFlag
            default: true
          - targetField: executeARRatingFlag
            default: false
          - targetField: executeAPRatingFlag
            default: false
        segmentListMapping:
          - targetSegment: shipment

            fieldMapping:
              - targetField: MITCCStrategyEnumVal
                default: "MITCC_CLEAR"

              - targetField: mergeInTransitConsolidationCode
                default: "' '"

              - targetField: shipmentNumber
                sourceField: currentShipment.shipmentNumber

              - targetField: shipmentInputSourceEnumVal
                sourceField: currentShipment.shipmentInputSourceEnumVal

              - targetField: freightTermsEnumVal
                sourceField: currentShipment.freightTermsEnumVal

              - targetField: shipFromLocationTypeEnumVal
                sourceField: currentShipment.shipFromLocationTypeEnumVal

              - targetField: shipFromLocationCode
                sourceField: currentShipment.shipFromLocationCode

              - targetField: shipFromAppointmentRequiredFlag
                sourceField: currentShipment.shipFromAppointmentRequiredFlag

              - targetField: pickupFromDateTime
                sourceField: currentShipment.pickupFromDateTime

              - targetField: pickupToDateTime
                sourceField: currentShipment.pickupToDateTime

              - targetField: deliveryFromDateTime
                sourceField: currentShipment.deliveryFromDateTime

              - targetField: deliveryToDateTime
                sourceField: currentShipment.deliveryToDateTime

              - targetField: carrierServiceEquipmentRuleEnumVal
                sourceField: currentShipment.carrierServiceEquipmentRuleEnumVal

              - targetField: ignoreChargeOverridesFlag
                sourceField: currentShipment.ignoreChargeOverridesFlag

              - targetField: ignoreReferenceNumbersFlag
                sourceField: currentShipment.ignoreReferenceNumbersFlag

              - targetField: ignoreThroughPointsFlag
                sourceField: currentShipment.ignoreThroughPointsFlag


 #process update shipment details flow
- sourceModel: warehouseOutboundInstructionSplit
  targetModel: process_shipment_container_maintain_update
  modelMapping:
    fieldVariableMapping:
      - variableName: filtered_shipment_items
        operations:
          - customFunction:
              functionName: get_filtered_shipment_items
              fields: [ field: warehousingOutboundInstruction.shipment, field: enrichment.shipment ]
    segmentListMapping:
      - targetSegment: payload
        sourceSegment: global_variable.filtered_shipment_items
        fieldMapping:
        - targetField: containerActionEnumVal
          default: "AT_UPDATE"

        segmentListMapping:
        - targetSegment: container
          sourceSegment: currentContainer
          fieldMapping:
            - targetField: systemContainerID
              sourceField: systemContainerID
            - targetField: containerTypeCode
              default: '*DFT'
            - targetField: ignoreReferenceNumbersFlag
              default: True
            - targetField: splitMethodEnumVal
              sourceField: splitMethodEnumVal
            - targetField: itemNumber
              sourceField: transactionalTradeItem.primaryId
            - targetField: itemDescription
              sourceField: itemDescription
            - targetField: itemPackageLevelIDCode
              sourceField: itemPackageLevelIDCode
            - targetField: contentLevelTypeCode
              sourceField: contentLevelTypeCode
            - targetField: is3DLoadingRequiredFlag
              sourceField: is3DLoadingRequiredFlag
            - targetField: numberOfUnits
              sourceField: numberOfUnits
            - targetField: quantity
              sourceField: plannedDespatchQuantity.value
            - targetField: ignoreWeightByFreightClassFlag
              operation:
              - customFunction:
                  functionName: get_ignore_weight_by_freight_class_flag
                  fields: [field: shipmentEntryModeEnumVal]
            - targetField: ignoreShipmentItemsFlag
              operation:
              - customFunction:
                  functionName: get_ignore_shipment_item_flag
                  fields: [field: shipmentEntryModeEnumVal]

          segmentMapping:
            - targetSegment: containerShippingInformation
              fieldMapping:
                - targetField: volume #UOM Conversion
                  operations:
                    - customFunction:
                        functionName: get_uom_conversion
                        fields: [ field: logisticUnit.unitMeasurement.measurementValue.value ,
                          field: logisticUnit.unitMeasurement.measurementValue.measurementUnitCode,
                          field: plannedDespatchQuantity.value,
                          property: tms.uom.volume,
                          constant: Volume
                        ]
                - targetField: nominalWeight
                  operations:
                    - customFunction:
                        functionName: get_uom_conversion
                        fields: [ field: logisticUnit.grossWeight.value ,
                          field: logisticUnit.grossWeight.measurementUnitCode,
                          field: plannedDespatchQuantity.value,
                          property: tms.uom.weight,
                          constant: Weight
                        ]

          segmentListMapping:
            - targetSegment: weightByFreightClass
              fieldMapping:
                - targetField: freightClassCode
                  operations:
                  - customFunction:
                      functionName: get_freight_class_code
                      fields: [field: freightClassCode, field: weightByFreightClass.freightClassCode]
                - targetField: freightClassNominalWeight
                  operations:
                    - customFunction:
                        functionName: get_uom_conversion
                        fields: [ field: logisticUnit.grossWeight.value ,
                          field: logisticUnit.grossWeight.measurementUnitCode,
                          field: plannedDespatchQuantity.value,
                          property: tms.uom.weight,
                          constant: Weight
                        ]

            - targetSegment: referenceNumberStructure
              fieldMapping:
                - targetField: referenceNumberTypeCode
                  default: "WM_ORDLIN_"
                - targetField: referenceNumber
                  sourceField: transactionalReference.lineItemNumber

            - targetSegment: referenceNumberStructure
              fieldMapping:
                - targetField: referenceNumberTypeCode
                  default: "DCS_ITEM_ID_"
                - targetField: referenceNumber
                  sourceField: transactionalTradeItem.primaryId


# process add split shipment flow
- sourceModel: warehouseOutboundInstructionSplit
  targetModel: process_shipment_create
  modelMapping:
    fieldVariableMapping:
      - variableName: filtered_shipment_items
        operations:
          - customFunction:
              functionName: get_filtered_shipment_items_add
              fields: [ field: warehousingOutboundInstruction.shipment, field: enrichment.shipment ]
    fieldMapping:
      - targetField: ignoreAllShipmentReferenceNumbersFlag
        # sourceField: inputPayload
        default: false
      - targetField: executeARRatingFlag
        default: false
      - targetField: executeAPRatingFlag
        default: false
    segmentListMapping:
      - targetSegment: shipment
        sourceSegment: global_variable.filtered_shipment_items
        fieldVariableMapping:
          - variableName: filtered_shipment_container_items
            operations:
              - customFunction:
                  functionName: get_filtered_shipment_items_containers
                  fields: [ field: currentEntity, field: currentShipment, field: tmShipmentId ]
        fieldMapping:
          - targetField: shipmentInputSourceEnumVal
            default: "IS_EXTERNAL_API"
          - targetField: carrierServiceEquipmentRuleEnumVal
            default: 'CSE_NULL'
          - targetField: ignoreChargeOverridesFlag
            default: false
          - targetField: ignoreReferenceNumbersFlag
            default: false
          - targetField: ignoreContainersFlag
            default: false
          - targetField: customerCode
            sourceField: currentShipment.customerCode

          - targetField: divisionCode
            sourceField: currentShipment.divisionCode
          - targetField: shipToAddress
            operations:
              - customFunction:
                  functionName: namespace_to_dict
                  fields: [ field: currentShipment.shipToAddress ]
          - targetField: shipFromAddress
            operations:
              - customFunction:
                  functionName: namespace_to_dict
                  fields: [ field: currentShipment.shipFromAddress ]

          - targetField: newNote
            operations:
              - customFunction:
                  functionName: get_note_details
                  fields: [ field: currentShipment.note ]

          - targetField: logisticsGroupCode
            sourceField: currentShipment.logisticsGroupCode
          - targetField: holdFlag
            sourceField: currentShipment.holdFlag
          - targetField: shipmentEntryModeEnumVal
            sourceField: currentShipment.shipmentEntryModeEnumVal
          - targetField: splitMethodEnumVal
            default: "SPLIT_METHOD_NONE"
          - targetField: shipmentPriority
            sourceField: currentShipment.shipmentPriority
          - targetField: freightTermsEnumVal
            sourceField: currentShipment.freightTermsEnumVal
          - targetField: shipDirectFlag
            sourceField: currentShipment.shipDirectFlag
          - targetField: shipmentConsolidationClassCode
            sourceField: currentShipment.shipmentConsolidationClassCode
          - targetField: mergeInTransitConsolidationCode
            sourceField: wmShipmentIdentification
          - targetField: shipFromLocationTypeEnumVal
            sourceField: currentShipment.shipFromLocationTypeEnumVal
          - targetField: shipFromLocationCode
            sourceField: currentShipment.shipFromLocationCode
          - targetField: shipFromDescription
            sourceField: currentShipment.shipFromDescription
          - targetField: shipFromAppointmentRequired
            sourceField: currentShipment.shipFromAppointmentRequired
          - targetField: shipToLocationTypeEnumVal
            sourceField: currentShipment.shipToLocationTypeEnumVal
          - targetField: shipToLocationCode
            sourceField: currentShipment.shipToLocationCode
          - targetField: shipToDescription
            sourceField: currentShipment.shipToDescription
          - targetField: shipToAppointmentRequiredFl
            sourceField: currentShipment.shipToAppointmentRequiredFl
          - targetField: pickupFromDateTime
            sourceField: currentShipment.pickupFromDateTime
          - targetField: pickupToDateTime
            sourceField: currentShipment.pickupToDateTime
          - targetField: deliveryFromDateTime
            sourceField: currentShipment.deliveryFromDateTime
          - targetField: deliveryToDateTime
            sourceField: currentShipment.deliveryToDateTime
          - targetField: commodityCode
            sourceField: currentShipment.commodityCode
          - targetField: unitOfMeasure
            operations:
              - customFunction:
                  functionName: namespace_to_dict
                  fields: [ field: currentShipment.unitOfMeasure ]
          - targetField: referenceNumberStructure
            operations:
              - customFunction:
                  functionName: get_shipment_reference_number_structure
                  fields: [ field:  currentShipment.referenceNumberStructure,
                            field: wmShipmentIdentification
                          ]
          - targetField: shipmentEntryTypeCode
            sourceField: currentShipment.shipmentEntryTypeCode
          - targetField: equipmentTypeCode
            sourceField: currentShipment.equipmentTypeCode
          - targetField: itineraryTemplateCode
            sourceField: currentShipment.itineraryTemplateCode
          - targetField: preferredAPCarrierCode
            sourceField: currentShipment.preferredAPCarrierCode
          - targetField: preferredAPServiceCode
            sourceField: currentShipment.preferredAPServiceCode
          - targetField: tractorEquipmentTypeCode
            sourceField: currentShipment.tractorEquipmentTypeCode
          - targetField: ARServiceCode
            sourceField: currentShipment.ARServiceCode
          - targetField: urgentFlag
            sourceField: currentShipment.urgentFlag
          - targetField: INCOTermsCode
            sourceField: currentShipment.INCOTermsCode
          - targetField: buyerSellerEnumVal
            sourceField: currentShipment.buyerSellerEnumVal
          - targetField: INCOShippingLocationCode
            sourceField: currentShipment.INCOShippingLocationCode
          - targetField: INCOShippingLocationTypeEnumVal
            sourceField: currentShipment.INCOShippingLocationTypeEnumVal
          - targetField: deferAPRatingFlag
            sourceField: currentShipment.deferAPRatingFlag
          - targetField: itemGroupCode
            sourceField: currentShipment.itemGroupCode
          - targetField: profitCenterCode
            sourceField: currentShipment.profitCenterCode
          - targetField: shipmentEntryVersionCode
            sourceField: currentShipment.shipmentEntryVersionCode
          - targetField: systemPlanID
            sourceField: currentShipment.systemPlanID
          - targetField: shipmentDescription
            sourceField: currentShipment.shipmentDescription
          - targetField: billToCustomerCode
            sourceField: currentShipment.billToCustomerCode
          - targetField: memo
            sourceField: currentShipment.memo
          - targetField: splitShipmentNumber
            sourceField: tmShipmentId

        segmentMapping:
          - targetSegment: throughPoint
            condition:
              - function:
                  functionName: is_not_null
                  fields: [ field: currentShipment.throughPoint ]
            fieldMapping:
            - targetField: shippingThroughPointEnumVal
              sourceField: currentShipment.throughPoint.shippingThroughPointEnumVal
            - targetField: shippingThroughPointLocationCode
              sourceField: currentShipment.throughPoint.shippingThroughPointLocationCode
            - targetField: carrierCode
              sourceField: currentShipment.throughPoint.carrierCode
            - targetField: serviceCode
              sourceField: currentShipment.throughPoint.serviceCode

          - targetSegment: chargeOverrides
            condition:
              - function:
                  functionName: is_not_null
                  fields: [ field: currentShipment.chargeOverrides ]
            fieldMapping:
            - targetField: applyAROptionEnumVal
              sourceField: currentShipment.chargeOverrides.applyAROptionEnumVal
            - targetField: chargeCode
              sourceField: currentShipment.ChargeOverrides.chargeCode
            - targetField: applyAPOptionEnumVal
              sourceField: currentShipment.ChargeOverrides.applyAPOptionEnumVal
            - targetField: manualOverrideUnits
              sourceField: currentShipment.ChargeOverrides.manualOverrideUnits
        segmentListMapping:
          - targetSegment: container
            sourceSegment: global_variable.filtered_shipment_container_items
            fieldMapping:
              - targetField: containerTypeCode
                default: "*DFT"
              - targetField: ignoreReferenceNumbersFlag
                default: False
              - targetField: splitMethodEnumVal
                sourceField: currentShipment.splitMethodEnumVal
              - targetField: itemNumber
                sourceField: currentItem.transactionalTradeItem.primaryId
              - targetField: itemDescription
                sourceField: currentContainer.itemDescription
              - targetField: itemPackageLevelIDCode
                sourceField: currentContainer.itemPackageLevelIDCode
              - targetField: contentLevelTypeCode
                sourceField: currentContainer.contentLevelTypeCode
              - targetField: is3DLoadingRequiredFlag
                sourceField: currentContainer.is3DLoadingRequiredFlag
              - targetField: numberOfUnits
                sourceField: currentContainer.numberOfUnits
              - targetField: quantity
                sourceField: currentItem.plannedDespatchQuantity.value
              - targetField: length
                sourceField: currentContainer.Length
              - targetField: height
                sourceField: currentContainer.Height
              - targetField: width
                sourceField: currentContainer.Width
              - targetField: ignoreWeightByFreightClassFlag
                default: false
              - targetField: ignoreShipmentItemsFlag
                default: true
              - targetField: referenceNumberStructure
                operations:
                  - customFunction:
                      functionName: namespace_to_dict
                      fields: [ field: currentContainer.referenceNumberStructure]

            segmentMapping:
              - targetSegment: containerShippingInformation
                fieldMapping:
                - targetField: volume
                  operations:
                    - customFunction:
                        functionName: get_uom_conversion
                        fields: [ field: currentItem.logisticUnit.unitMeasurement.measurementValue.value ,
                          field: currentItem.logisticUnit.unitMeasurement.measurementValue.measurementUnitCode,
                          field: currentItem.plannedDespatchQuantity.value,
                          property: tms.uom.volume,
                          constant: Volume
                        ]
                - targetField: nominalWeight
                  operations:
                    - customFunction:
                        functionName: get_uom_conversion
                        fields: [ field: currentItem.logisticUnit.grossWeight.value ,
                          field: currentItem.logisticUnit.grossWeight.measurementUnitCode,
                          field: currentItem.plannedDespatchQuantity.value,
                          property: tms.uom.weight,
                          constant: Weight
                        ]
                - targetField: ladenLength
                  sourceField: currentContainer.containerShippingInformation.LadenLength

            segmentListMapping:
              - targetSegment: weightByFreightClass
                fieldMapping:
                  - targetField: freightClassCode
                    operations:
                      - customFunction:
                          functionName: get_freight_class_code
                          fields: [ field: currentItem.freightClassCode, field: currentContainer.weightByFreightClass.freightClassCode ]

                  - targetField: freightClassNominalWeight
                    operations:
                      - customFunction:
                          functionName: get_uom_conversion
                          fields: [ field: currentItem.logisticUnit.grossWeight.value ,
                                    field: currentItem.logisticUnit.grossWeight.measurementUnitCode,
                                    field: currentItem.plannedDespatchQuantity.value,
                                    property: tms.uom.weight,
                                    constant: Weight
                          ]


# process delete shipment detail flow
- sourceModel: warehousingOutboundInstruction
  targetModel: process_shipment_container_maintain_delete
  modelMapping:
    fieldVariableMapping:
      - variableName: system_container_id
        operations:
          - customFunction:
              functionName: get_system_container_id
              fields: [ field: warehousingOutboundInstruction.shipment, field: enrichment.shipment ]
    segmentListMapping:
      - targetSegment: payload
        sourceSegment: global_variable.system_container_id
        fieldMapping:
          - targetField: containerActionEnumVal
            default: AT_DELETE

        segmentListMapping:
          - targetSegment: container
            sourceSegment: containers
            fieldMapping:
              - targetField: systemContainerID
                sourceField: containerLineItemNumber


#process removed from planned load
- sourceModel: warehouseOutboundInstructionSplit
  targetModel: remove_shipment_from_current_load
  modelMapping:
    fieldVariableMapping:
      - variableName: remove_shipment_from_current_load
        operations:
          - customFunction:
              functionName: get_remove_shipment_from_current_load
              fields: [ field: warehousingOutboundInstruction.shipment, field: enrichment.shipment ]
    segmentListMapping:
    - targetSegment: removeFromPlannedLoadData
      sourceSegment: global_variable.remove_shipment_from_current_load
      fieldMapping:
        - targetField: systemLoadID
          sourceField: currentShipment.systemLoadID
        - targetField: systemShipmentLegID
          operations:
            - customFunction:
                functionName: get_system_shipment_leg_id
                fields: [field: currentShipment.shipmentLeg ]


# process delete shipment detail flow whole shipment split
- sourceModel: warehousingOutboundInstruction
  targetModel: process_shipment_details_delete
  modelMapping:
    fieldVariableMapping:
      - variableName: remove_shipment_from_current_load
        operations:
          - customFunction:
              functionName: get_remove_shipment_from_current_load
              fields: [ field: warehousingOutboundInstruction.shipment,
                        field: enrichment.shipment ]
    segmentListMapping:
      - targetSegment: shipment
        sourceSegment: global_variable.remove_shipment_from_current_load
        fieldMapping:
          - targetField: shipmentNumber
            operations:
              - customFunction:
                  functionName: get_shipment_number
                  fields: [ field: distinctItem ]
