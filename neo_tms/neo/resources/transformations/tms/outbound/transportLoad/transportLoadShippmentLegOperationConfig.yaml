---
- sourceModel: transportLoadShipmentLeg
  targetModel: ShipmentLegOperation
  sourceCondition:
    customFunction:
      functionName: check_shipment_leg_operation
      functionArgs: [ field: CISDocument.EventName, field: CISDocument.SystemShipmentLegID ]
  modelMapping:
    headerMapping:
      segmentListMapping:
        - targetSegment: headerSegment
          fieldMapping:
          - targetField: receivers
            operations:
              - customFunction:
                  functionName: generate_dynamic_receivers_transport_load_shipment_leg
                  fields: [field: enrichment.loadType.stop, field: CISDocument.ShipmentLegOriginCode]

    fieldVariableMapping:
      - variableName: payload
        variableValue: current_payload

    segmentMapping:
      - targetSegment: header
        fieldMapping:
          - targetField: sender
            default: "TMS.GLOBAL"
          - targetField: receiver
            operations:
              - customFunction:
                  functionName: generate_dynamic_receivers_transport_load_shipment_leg
                  fields: [field: enrichment.loadType.stop, field: CISDocument.ShipmentLegOriginCode]
          - targetField: messageVersion
            operations:
              - customFunction:
                  functionName: get_TL_messageVersion_shipment_leg
                  fields: [property: 'workflow.outbound.transportLoad.TL.message.message_version']
            default: "BYDM 2021.9.0"

          - targetField: messageId
            operations:
              - customFunction:
                  functionName: generate_uuid
          - targetField: type
            default: "transportLoad"
          - targetField: creationDateAndTime # add a custom function to get current system UTC date time
            operations:
              - customFunction:
                  functionName: get_current_timestamp_iso8601
                  fields: []
    segmentListMapping:
      - targetSegment: transportLoad
        fieldMapping:
          - targetField: creationDateTime
            operations:
              - function:
                  functionName: getDateTime
                  functionArguments: [
                      field: enrichment.loadType.createdDateTime,
                      constant: "False",
                      property: "date_formats.tm_date_time_format",
                      property: "date_formats.gs1_date_time_format",
                      constant: "False",
                      property: "tms_default_timezone.timezone"
                  ]
          - targetField: documentStatusCode
            default: "ORIGINAL"
          - targetField: documentActionCode
            default: "CHANGE_BY_REFRESH"
          - targetField: lastUpdateDateTime
            operations:
              - function:
                  functionName: getDateTime
                  functionArguments: [
                      field: enrichment.loadType.updatedDateTime,
                      constant: "False",
                      property: "date_formats.tm_date_time_format",
                      property: "date_formats.gs1_date_time_format",
                      constant: "False",
                      property: "tms_default_timezone.timezone"
                  ]
          - targetField: transportLoadId
            sourceField: enrichment.loadType.systemLoadID
          - targetField: loadStatusCode
            operations:
              - function:
                  functionName: getCodemap
                  functionArguments: [constant: "LoadStatusCodeTypeFromAppToGS1", field: enrichment.loadType.currentLoadOperationalStatusEnumVal]
          - targetField: transportModeCode
            operations:
              - function:
                  functionName: getCodemap
                  functionArguments: [constant: "TransportServiceCategoryCodeFromAppToGS1", field: enrichment.masterServiceType.transitModeEnumVal]
          - targetField: transportServiceCategoryType
            operations:
              - function:
                  functionName: getCodemap
                  functionArguments: [ constant: "TransportServiceCategoryCodeFromAppToGS1", field: enrichment.masterServiceType.transitModeEnumVal]

          - targetField: transportServiceLevelCode
            operations:
              - function:
                  functionName: getCodemap
                  functionArguments: [ constant: "transportServiceLevelCode", field: enrichment.loadType.serviceCode, constant: "True" ]

          - targetField: externalTransportServiceLevelCode1
            sourceField: CISDocument.Service.ServiceExternalID1
          - targetField: externalTransportServiceLevelCode2
            sourceField: CISDocument.Service.ServiceExternalID2
          - targetField: tripId
            sourceField: CISDocument.TripID
          - targetField: loadStartDateTime
            operations:
              - function:
                  functionName: getDateTime
                  functionArguments: [
                      field: enrichment.loadType.loadStartDateTime,
                      constant: "False",
                      property: "date_formats.tm_date_time_format",
                      property: "date_formats.gs1_date_time_format",
                      constant: "False",
                      property: "tms_default_timezone.timezone"
                  ]
          - targetField: loadEndDateTime
            operations:
              - function:
                  functionName: getDateTime
                  functionArguments: [
                      field: enrichment.loadType.loadEndDateTime,
                      constant: "False",
                      property: "date_formats.tm_date_time_format",
                      property: "date_formats.gs1_date_time_format",
                      constant: "False",
                      property: "tms_default_timezone.timezone"
                  ]
          - targetField: numberOfPickUpStops
            operations:
              - customFunction:
                  functionName: get_total_pickup_stops_shipment_leg
                  fields: [field: enrichment.loadType.stop]
          - targetField: numberOfDropOffStops
            operations:
              - customFunction:
                  functionName: get_total_dropoff_stops_shipment_leg
                  fields: [field: enrichment.loadType.stop]
          - targetField: affectedOriginLocation
            operations:
              - customFunction:
                  functionName: generate_affectedOriginLocation_shipment_leg
                  fields: [field: enrichment.loadType.stop, field: CISDocument.ShipmentLegOriginCode, property: 'tl_parsing.enabled']
        segmentMapping:
          - targetSegment: logisticServicesSeller
            fieldMapping:
              - targetField: primaryId
                sourceField: enrichment.loadType.carrierCode
            segmentListMapping:
              - targetSegment: contact
                fieldMapping:
                  - targetField: departmentName
                    sourceField: enrichment.loadType.logisticsGroupCode

          - targetSegment: logisticServicesBuyer
            fieldMapping:
              - targetField: primaryId
                sourceField: enrichment.loadType.shipmentLeg.shipment.customerCode

          - targetSegment: driver
            #add condition to check if driver code present
            fieldMapping:
              - targetField: driverId
                sourceField: enrichment.loadType.shipmentLeg.shipment.driverCode

          - targetSegment: transportCargoCharacteristics
            fieldMapping:
              - targetField: cargoTypeCode
                default: "12"                 # represent "General Cargo"
            segmentMapping:
              - targetSegment: totalGrossVolume
                condition:
                  function:
                    functionName: is_not_null
                    functionArguments: [ field: CISDocument.LoadTotals.LoadVolume ]
                fieldMapping:
                  - targetField: measurementUnitCode
                    default: "FTQ"
                  - targetField: value
                    operations:
                      - function:
                          functionName: getUomConversion
                          functionArguments: [constant: "Volume", field: CISDocument.LoadUOM.LoadVolumeUOM, constant: "FTQ", field: CISDocument.LoadTotals.LoadVolume ]
              - targetSegment: totalGrossWeight
                condition:
                  function:
                    functionName: is_not_null
                    functionArguments: [ field: CISDocument.LoadTotals.LoadWeight]
                fieldMapping:
                  - targetField: measurementUnitCode
                    default: "LBR"
                  - targetField: value
                    operations:
                      - function:
                          functionName: getUomConversion
                          functionArguments: [constant: "Weight", field: CISDocument.LoadUOM.LoadWeightUOM, constant: "LBR", field: CISDocument.LoadTotals.LoadWeight ]
              - targetSegment: totalPackageQuantity
                condition:
                  function:
                    functionName: is_not_null
                    functionArguments: [ field: enrichment.loadType.totalSkids]
                fieldMapping:
                  - targetField: measurementUnitCode
                    default: "PF"
                  - targetField: value
                    sourceField: enrichment.loadType.totalSkids

          - targetSegment: carrier
            fieldMapping:
              - targetField: primaryId
                sourceField: enrichment.loadType.carrierCode

          - targetSegment: transportEquipment
            condition:
              customFunction:
                functionName: check_if_all_arg_is_not_null #to be implemented
                fields: [ field: enrichment.loadType.equipmentTypeCode, field: enrichment.loadType.trailerNumber ]
            segmentMapping:
              - targetSegment: transportEquipmentTypeCode
                fieldMapping:
                - targetField: value
                  sourceField: enrichment.loadType.equipmentTypeCode
            segmentListMapping:
              - targetSegment: assetId
                fieldMapping:
                - targetField: primaryId
                  sourceField: enrichment.loadType.trailerNumber
                segmentListMapping:
                  - targetSegment: additionalIndividualAssetId
                    fieldMapping:
                      - targetField: value
                        default: "0000"
                      - targetField: typeCode
                        default: "GIAI"
        segmentListMapping:
          - targetSegment: transportReference
            condition:
              customFunction:
                functionName: check_valid_transportReference #to be implemented
                fields: [ field: enrichment.loadType.loadDescription, field: enrichment.loadType.referenceNumberStructure ]
            fieldMapping:
              - targetField: entityId
                operations:
                - customFunction:
                    functionName: get_entityId_transportReference_shipment_leg
                    fields: [ field: enrichment.loadType.loadDescription, field: enrichment.loadType.referenceNumberStructure ]
              - targetField: typeCode
                default: "TRA"

          - targetSegment: tmReferenceNumber
            sourceSegment: enrichment.loadType.referenceNumberStructure
            fieldMapping:
              - targetField: referenceNumberName
                sourceField: referenceNumberTypeCode
              - targetField: referenceNumberValue
                sourceField: referenceNumber

          - targetSegment: stop
            sourceSegment: enrichment.loadType.stop
            fieldMapping:
              - targetField: stopSequenceNumber
                sourceField: stopSequenceNumber
              - targetField: stopId
                sourceField: systemStopID
              - targetField: stopLocationType
                sourceField: shippingLocationTypeEnumVal
              - targetField: pickupShipmentCount
                sourceField: countOfShipmentsPickedAtStop
              - targetField: pickupShipmentLegId
                sourceField: pickShipmentLegID
              - targetField: dropoffShipmentCount
                sourceField: countOfShipmentsDroppedAtStop
              - targetField: pickupShipmentReference
                operations:
                  - customFunction:
                      functionName: get_pickupShipmentReference_for_stops_TL_shipment_leg
                      fields: [field: pickShipmentLegID, field: global_variable.payload.enrichment.loadType.shipmentLeg]
              - targetField: dropoffShipmentReference
                operations:
                  - customFunction:
                      functionName: get_dropoffShipmentReference_for_stops_TL_shipment_leg
                      fields: [field: dropShipmentLegID, field: global_variable.payload.enrichment.loadType.shipmentLeg]
              - targetField: dropoffShipmentLegId
                sourceField: dropShipmentLegID
            segmentMapping:
              - targetSegment: stopLocation
                fieldMapping:
                  - targetField: additionalLocationId
                    operations:
                    - customFunction:
                        functionName: get_arg_as_list
                        fields: [ field: shippingLocationCode ]
                  - targetField: sublocationId
                    operations:
                      - customFunction:
                          functionName: get_dock_slot_identifier_shipment_leg
                          fields: [ field: shippingLocationCode, field: global_variable.payload.enrichment.dockType]
                  - targetField: dockId
                    operations:
                      - customFunction:
                          functionName: get_dockId_shipment_leg
                          fields: [ field: shippingLocationCode, field: global_variable.payload.enrichment.dockType]

                segmentMapping:
                  - targetSegment: address
                    sourceSegment: address
                    fieldMapping:
                      - targetField: city
                        sourceField: city
                      - targetField: countryCode
                        sourceField: countryCode
                      - targetField: postalCode
                        sourceField: postalCode
                      - targetField: state
                        sourceField: state
                      - targetField: streetAddressOne
                        sourceField: street
                  - targetSegment: locationSpecificInstructions
                    fieldMapping:
                      - targetField: languageCode
                        default: "en"
                      - targetField: value
                        operations:
                          - customFunction:
                              functionName: get_dock_type_code_shipment_leg
                              fields:
                                [
                                  field: shippingLocationCode,
                                  field: enrichment.dockType
                                ]

              - targetSegment: distanceFromPreviousStop
                fieldMapping:
                  - targetField: value
                    sourceField: distanceFromPreviousStop
                  - targetField: measurementUnitCode
                    default: "SMI"

              - targetSegment: transitTimeFromPreviousStop
                fieldMapping:
                  - targetField: value
                    sourceField: transitTimeFromPreviousStop
                  - targetField: timeMeasurementUnitCode
                    default: "HUR"

            segmentListMapping:
              - targetSegment: stopLogisticEvent
                condition:
                  customFunction:
                    functionName: check_if_any_arg_is_not_null #to be implemented
                    fields: [ field: lastComputedArrivalDateTime, field: appointment ]

                fieldMapping:
                  - targetField: logisticEventTypeCode
                    default: "TERMINAL_ARRIVAL"
                segmentMapping:
                  - targetSegment: logisticEventDateTime
                    fieldMapping:
                      - targetField: date
                        operations:
                          - customFunction:
                              functionName: getDateComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields:
                                [
                                  field: lastComputedArrivalDateTime,
                                  field: appointment
                                ]
                      - targetField: time
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields: [
                                  field: lastComputedArrivalDateTime,
                                  field: appointment,
                                  field: global_variable.payload.enrichment.dockType,
                                  field: shippingLocationCode,
                                  property: "tms_default_timezone.timezone"
                                ]
              - targetSegment: stopLogisticEvent
                condition:
                  customFunction:
                    functionName: check_if_any_arg_is_not_null #to be implemented
                    fields: [field: lastComputedDepartureDateTime, field: appointment]
                fieldMapping:
                  - targetField: logisticEventTypeCode
                    default: "TERMINAL_DEPARTURE"
                segmentMapping:
                  - targetSegment: logisticEventDateTime
                    fieldMapping:
                      - targetField: date
                        operations:
                          - customFunction:
                              functionName: getDateComponentForTL_logisticEvent_To_shipment_leg #to be implemented
                              fields:
                                [
                                  field: lastComputedDepartureDateTime,
                                  field: appointment
                                ]
                      - targetField: time
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_To_shipment_leg #to be implemented
                              fields: [
                                  field: lastComputedDepartureDateTime,
                                  field: appointment,
                                  field: global_variable.payload.enrichment.dockType,
                                  field: shippingLocationCode,
                                  property: "tms_default_timezone.timezone"
                                ]
              - targetSegment: stopLogisticEvent
                condition:
                  customFunction:
                    functionName: check_if_valid_loading_unloading_logistic_event
                    fields: [
                        field: lastComputedArrivalDateTime,
                        field: lastComputedDepartureDateTime,
                        field: appointment,
                        field: countOfShipmentsPickedAtStop
                        ]
                fieldMapping:
                  - targetField: logisticEventTypeCode
                    default: "LOADING"
                segmentMapping:
                  - targetSegment: logisticEventDateTime
                    fieldMapping:
                      - targetField: beginDate
                        operations:
                          - customFunction:
                              functionName: getDateComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields:
                                [
                                  field: lastComputedArrivalDateTime,
                                  field: appointment
                                ]
                      - targetField: beginTime
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_From_shipment_leg
                              fields: [
                                        field: lastComputedArrivalDateTime,
                                        field: appointment,
                                        field: global_variable.payload.enrichment.dockType,
                                        field: shippingLocationCode,
                                        property: "tms_default_timezone.timezone"
                                      ]
                      - targetField: endDate
                        operations:
                          - customFunction:
                              functionName: getDateComponentForTL_logisticEvent_To_shipment_leg #to be implemented
                              fields:
                                [
                                  field: lastComputedDepartureDateTime,
                                  field: appointment
                                ]
                      - targetField: endTime
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_To_shipment_leg #to be implemented
                              fields: [
                                  field: lastComputedDepartureDateTime,
                                  field: appointment,
                                  field: global_variable.payload.enrichment.dockType,
                                  field: shippingLocationCode,
                                  property: "tms_default_timezone.timezone"
                                ]
              - targetSegment: stopLogisticEvent
                condition:
                  customFunction:
                    functionName: check_if_valid_loading_unloading_logistic_event
                    fields: [
                        field: lastComputedArrivalDateTime,
                        field: lastComputedDepartureDateTime,
                        field: appointment,
                        field: countOfShipmentsDroppedAtStop
                        ]
                fieldMapping:
                  - targetField: logisticEventTypeCode
                    default: "UNLOADING"
                segmentMapping:
                  - targetSegment: logisticEventDateTime
                    fieldMapping:
                      - targetField: beginDate
                        operations:
                          - customFunction:
                              functionName: getDateComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields:
                                [
                                  field: lastComputedArrivalDateTime,
                                  field: appointment
                                ]
                      - targetField: beginTime
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields: [
                                  field: lastComputedArrivalDateTime,
                                  field: appointment,
                                  field: global_variable.payload.enrichment.dockType,
                                  field: shippingLocationCode,
                                  property: "tms_default_timezone.timezone"
                                ]
                      - targetField: endDate
                        operations:
                          - customFunction:
                              functionName: getDateComponentForTL_logisticEvent_To_shipment_leg #to be implemented
                              fields:
                                [
                                  field: lastComputedDepartureDateTime,
                                  field: appointment,
                                ]
                      - targetField: endTime
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_To_shipment_leg #to be implemented
                              fields: [
                                  field: lastComputedDepartureDateTime,
                                  field: appointment,
                                  field: global_variable.payload.enrichment.dockType,
                                  field: shippingLocationCode,
                                  property: "tms_default_timezone.timezone"
                                ]

              - targetSegment: pickupTotal #uom conversion is required still
                fieldMapping:
                  - targetField: measurementType
                    default: "TOTAL_GROSS_WEIGHT"
                segmentMapping:
                  - targetSegment: measurementValue
                    fieldMapping:
                      - targetField: measurementUnitCode
                        default: "LBR"
                      - targetField: value
                        sourceField: pickedWeight

              - targetSegment: pickupTotal #uom conversion is required still
                fieldMapping:
                  - targetField: measurementType
                    default: "GROSS_VOLUME"
                segmentMapping:
                  - targetSegment: measurementValue
                    fieldMapping:
                      - targetField: measurementUnitCode
                        default: "FTQ"
                      - targetField: value
                        sourceField: pickedVolume

              - targetSegment: pickupTotal
                fieldMapping:
                  - targetField: measurementType
                    default: "PACKAGES"
                segmentMapping:
                  - targetSegment: measurementValue
                    fieldMapping:
                      - targetField: measurementUnitCode
                        default: "EA"
                      - targetField: value
                        sourceField: pickedPieces

              - targetSegment: pickupTotal
                condition:
                  customFunction:
                    functionName: check_if_valid_picked_skids
                    fields: [field: pickedSkids]
                fieldMapping:
                  - targetField: measurementType
                    default: "PALLETS"
                segmentMapping:
                  - targetSegment: measurementValue
                    fieldMapping:
                      - targetField: measurementUnitCode
                        default: "PF"
                      - targetField: value
                        sourceField: pickedSkids

              - targetSegment: dropoffTotal #uom conversion required
                fieldMapping:
                  - targetField: measurementType
                    default: "TOTAL_GROSS_WEIGHT"
                segmentMapping:
                  - targetSegment: measurementValue
                    fieldMapping:
                      - targetField: measurementUnitCode
                        default: "LBR"
                      - targetField: value
                        sourceField: droppedWeight

              - targetSegment: dropoffTotal #uom conversion required
                fieldMapping:
                  - targetField: measurementType
                    default: "GROSS_VOLUME"
                segmentMapping:
                  - targetSegment: measurementValue
                    fieldMapping:
                      - targetField: measurementUnitCode
                        default: "FTQ"
                      - targetField: value
                        sourceField: droppedVolume

              - targetSegment: dropoffTotal
                fieldMapping:
                  - targetField: measurementType
                    default: "PACKAGES"
                segmentMapping:
                  - targetSegment: measurementValue
                    fieldMapping:
                      - targetField: measurementUnitCode
                        default: "EA"
                      - targetField: value
                        sourceField: droppedPieces

              - targetSegment: dropoffTotal
                condition:
                  customFunction:
                    functionName: check_if_valid_dropped_skids
                    fields: [field: droppedSkids]
                fieldMapping:
                  - targetField: measurementType
                    default: "PALLETS"
                segmentMapping:
                  - targetSegment: measurementValue
                    fieldMapping:
                      - targetField: measurementUnitCode
                        default: "PF"
                      - targetField: value
                        sourceField: droppedSkids

              - targetSegment: transportReference # to check
                condition:
                  customFunction:
                    functionName: check_if_valid_dock_commitment_id
                    fields: [ field: shippingLocationCode, field: enrichment.dockType]
                fieldMapping:
                  - targetField: entityId
                    operations:
                    - customFunction:
                        functionName: get_systemDockCommitmentID_shipment_leg
                        fields: [ field: shippingLocationCode, field: global_variable.payload.enrichment.dockType]
                  - targetField: typeCode
                    default: "TPD"  #TMS

          - targetSegment: stop
            condition:
              customFunction:
                functionName: check_if_last_shipment_remove #to be implemented
                fields: [ field: enrichment.loadType.stop, field: CISDocument.ShipmentLegOriginCode]
            fieldMapping:
              - targetField: stopSequenceNumber
                default: 1
            segmentMapping:
              - targetSegment: stopLocation
                fieldMapping:
                  - targetField: additionalLocationId
                    operations:
                    - customFunction:
                        functionName: get_arg_as_list
                        fields: [ field: CISDocument.ShipmentLegOriginCode ]
            segmentListMapping:
              - targetSegment: pickupShipmentReference
                fieldMapping:
                  - targetField: primaryId
                    sourceField: CISDocument.Shipment.SystemShipmentNumber
                segmentListMapping:
                  - targetSegment: additionalShipmentId
                    fieldMapping:
                      - targetField: typeCode
                        default: "SHIPPER_ASSIGNED"
                      - targetField: value
                        default: "00000000000000000"
              - targetSegment: stopLogisticEvent
                fieldMapping:
                  - targetField: logisticEventTypeCode
                    default: "TERMINAL_ARRIVAL"
                segmentMapping:
                  - targetSegment: logisticEventDateTime
                    fieldMapping:
                      - targetField: date
                        operations:
                          - customFunction:
                              functionName: getDateComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields: [
                                      field: global_variable.payload.enrichment.loadType.updatedDateTime,
                                      constant: None
                                      ]
                      - targetField: time
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields: [
                                  field: global_variable.payload.enrichment.loadType.updatedDateTime,
                                  field: None,
                                  field: global_variable.payload.enrichment.dockType,
                                  field: shippingLocationCode,
                                  property: "tms_default_timezone.timezone"
                                ]
              - targetSegment: stopLogisticEvent
                fieldMapping:
                  - targetField: logisticEventTypeCode
                    default: "TERMINAL_DEPARTURE"
                segmentMapping:
                  - targetSegment: logisticEventDateTime
                    fieldMapping:
                      - targetField: date
                        operations:
                          - customFunction:
                              functionName: getDateComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields:
                                [
                                  field: global_variable.payload.enrichment.loadType.updatedDateTime,
                                  constant: None
                                ]
                      - targetField: time
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields: [
                                  field: global_variable.payload.enrichment.loadType.updatedDateTime,
                                  constant: None,
                                  field: global_variable.payload.enrichment.dockType,
                                  field: shippingLocationCode,
                                  property: "tms_default_timezone.timezone"
                                ]

          - targetSegment: stop
            condition:
              customFunction:
                functionName: check_if_last_shipment_remove #to be implemented
                fields: [ field: enrichment.loadType.stop, field: CISDocument.ShipmentLegDestinationCode]
            fieldMapping:
              - targetField: stopSequenceNumber
                default: 2
            segmentMapping:
              - targetSegment: stopLocation
                fieldMapping:
                  - targetField: additionalLocationId
                    operations:
                    - customFunction:
                        functionName: get_arg_as_list
                        fields: [ field: CISDocument.ShipmentLegDestinationCode ]
            segmentListMapping:
              - targetSegment: dropoffShipmentReference
                fieldMapping:
                  - targetField: primaryId
                    sourceField: CISDocument.Shipment.SystemShipmentNumber
                segmentListMapping:
                  - targetSegment: additionalShipmentId
                    fieldMapping:
                      - targetField: typeCode
                        default: "SHIPPER_ASSIGNED"
                      - targetField: value
                        default: "00000000000000000"
              - targetSegment: stopLogisticEvent
                fieldMapping:
                  - targetField: logisticEventTypeCode
                    default: "TERMINAL_ARRIVAL"
                segmentMapping:
                  - targetSegment: logisticEventDateTime
                    fieldMapping:
                      - targetField: date
                        operations:
                          - customFunction:
                              functionName: getDateComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields:
                                [
                                  field: global_variable.payload.enrichment.loadType.updatedDateTime,
                                  constant: None
                                ]
                      - targetField: time
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields: [
                                  field: global_variable.payload.enrichment.loadType.updatedDateTime,
                                  constant: None,
                                  field: global_variable.payload.enrichment.dockType,
                                  field: shippingLocationCode,
                                  property: "tms_default_timezone.timezone"
                                ]
              - targetSegment: stopLogisticEvent
                fieldMapping:
                  - targetField: logisticEventTypeCode
                    default: "TERMINAL_DEPARTURE"
                segmentMapping:
                  - targetSegment: logisticEventDateTime
                    fieldMapping:
                      - targetField: date
                        operations:
                          - customFunction:
                              functionName: getDateComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields:
                                [
                                  field: global_variable.payload.enrichment.loadType.updatedDateTime,
                                  constant: None
                                ]
                      - targetField: time
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_From_shipment_leg #to be implemented
                              fields: [
                                  field: global_variable.payload.enrichment.loadType.updatedDateTime,
                                  constant: None,
                                  field: global_variable.payload.enrichment.dockType,
                                  field: shippingLocationCode,
                                  property: "tms_default_timezone.timezone"
                                ]

          - targetSegment: shipment
            sourceSegment: enrichment.loadType.shipmentLeg
            fieldVariableMapping:
              - variableName: currentShipmentLeg
                variableValue: current_payload
            fieldMapping:
              - targetField: primaryId
                sourceField: shipment.shipmentNumber
              - targetField: ownerOfShipment
                sourceField: shipment.customerCode
              - targetField: logisticServiceRequirementCode
                operations:
                  - function:
                      functionName: getCodemap
                      functionArguments: [ constant: "TransportServiceTransitModeFromAppToGS1", field: global_variable.payload.enrichment.loadType.serviceCode ]
              - targetField: transportServiceCategoryType
                operations:
                  - function:
                      functionName: getCodemap
                      functionArguments: [ constant: "TransportServiceCategoryCodeFromAppToGS1", field: global_variable.payload.enrichment.masterServiceType.transitModeEnumVal ]
              - targetField: shipmentLegId
                sourceField: systemShipmentLegID
              - targetField: isMultiLegShipment
                operations:
                  - customFunction:
                      functionName: is_multi_leg_shipment_shipment_leg
                      fields: [field: shipment.numberOfShipmentLegs]

              - targetField: isCrossDockLeg
                operations:
                  - customFunction:
                      functionName: is_cross_dock_leg_shipment_leg #RMS
                      fields: [ field: shipment.numberOfShipmentLegs, field: shipFromLocationCode, field: shipment.shipFromLocationCode]
              - targetField: transportReference
                operations:
                  - customFunction:
                      functionName: get_shipment_transportReference_shipment_leg
                      fields: [ field: global_variable.currentShipmentLeg ]
            segmentMapping:
              - targetSegment: parentShipmentID
                condition:
                  function:
                    functionName: is_not_null
                    functionArguments: [ field: shipment.splitShipmentNumber ]
                fieldMapping:
                  - targetField: primaryId
                    sourceField: shipment.splitShipmentNumber
                segmentListMapping:
                  - targetSegment: additionalShipmentId
                    fieldMapping:
                      - targetField: typeCode
                        default: "SHIPPER_ASSIGNED"
                      - targetField: value
                        default: "00000000000000000"

              - targetSegment: receiver
                fieldMapping:
                  - targetField: primaryId
                    sourceField: shipment.customerCode
              - targetSegment: shipper
                fieldMapping:
                  - targetField: primaryId
                    sourceField: shipment.customerCode
              - targetSegment: shipTo
                fieldMapping:
                  - targetField: primaryId
                    sourceField: shipment.shipToLocationCode
                segmentMapping:
                  - targetSegment: address
                    condition:
                      function:
                        functionName: is_not_null
                        functionArguments: [ field: shipment.shipToAddress ]
                    fieldMapping:
                      - targetField: city
                        sourceField: shipment.shipToAddress.city
                      - targetField: countryCode
                        sourceField: shipment.shipToAddress.countryCode
                      - targetField: postalCode
                        sourceField: shipment.shipToAddress.postalCode
                      - targetField: state
                        sourceField: shipment.shipToAddress.state
                      - targetField: streetAddressOne
                        sourceField: shipment.shipToAddress.street
                      - targetField: streetAddressTwo
                        sourceField: shipment.shipToAddress.block
                      - targetField: streetAddressThree
                        sourceField: shipment.shipToAddress.unit
                    segmentMapping:
                      - targetSegment: geographicalCoordinates
                        condition:
                          customFunction:
                            functionName: check_if_any_arg_is_not_null #to be implemented
                            fields: [ field: shipment.shipFromAddress.latitude, field: shipment.shipFromAddress.longitude ]
                        fieldMapping:
                          - targetField: latitude
                            sourceField: shipment.shipToAddress.latitude
                          - targetField: longitude
                            sourceField: shipment.shipToAddress.longitude

              - targetSegment: shipFrom
                fieldMapping:
                  - targetField: primaryId
                    sourceField: shipment.shipFromLocationCode
                segmentMapping:
                  - targetSegment: address
                    condition:
                      function:
                        functionName: is_not_null
                        functionArguments: [ field: shipment.shipFromAddress]
                    fieldMapping:
                      - targetField: city
                        sourceField: shipment.shipFromAddress.city
                      - targetField: countryCode
                        sourceField: shipment.shipFromAddress.countryCode
                      - targetField: postalCode
                        sourceField: shipment.shipFromAddress.postalCode
                      - targetField: state
                        sourceField: shipment.shipFromAddress.state
                      - targetField: streetAddressOne
                        sourceField: shipment.shipFromAddress.street
                      - targetField: streetAddressTwo
                        sourceField: shipment.shipFromAddress.block
                      - targetField: streetAddressThree
                        sourceField: shipment.shipFromAddress.unit
                    segmentMapping:
                      - targetSegment: geographicalCoordinates
                        condition:
                          customFunction:
                            functionName: check_if_any_arg_is_not_null #to be implemented
                            fields: [ field: shipment.shipFromAddress.latitude, field: shipment.shipFromAddress.longitude ]
                        fieldMapping:
                          - targetField: latitude
                            sourceField: shipment.shipFromAddress.latitude
                          - targetField: longitude
                            sourceField: shipment.shipFromAddress.longitude

              - targetSegment: transportCargoCharacteristics
                fieldMapping:
                  - targetField: cargoTypeCode
                    default: "12" #represent General Cargo
                segmentMapping:
                  - targetSegment: totalPackageQuantity
                    condition:
                      function:
                        functionName: is_not_null
                        functionArguments: [ field: skids]
                    fieldMapping:
                      - targetField: measurementUnitCode
                        default: "PF"
                      - targetField: value
                        sourceField: skids

              - targetSegment: plannedDelivery
                segmentMapping:
                  - targetSegment: logisticEventPeriod
                    fieldMapping:
                      - targetField: beginDate
                        operations:
                          - customFunction:
                              functionName: get_date_component_shipment_leg
                              fields: [ field: shipment.deliveryFromDateTime ]
                      - targetField: beginTime
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_From_shipment_leg
                              fields: [ field: shipment.deliveryFromDateTime,
                                        field: None,
                                        field: global_variable.payload.enrichment.dockType,
                                        field: shippingLocationCode,
                                        property: "tms_default_timezone.timezone"
                                    ]
                      - targetField: endDate
                        operations:
                          - customFunction:
                              functionName: get_date_component_shipment_leg
                              fields: [ field: shipment.deliveryToDateTime ]
                      - targetField: endTime
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_To_shipment_leg
                              fields: [ field: shipment.deliveryToDateTime,
                                          field: None,
                                          field: global_variable.payload.enrichment.dockType,
                                          field: shippingLocationCode,
                                          property: "tms_default_timezone.timezone"
                                      ]

              - targetSegment: plannedDespatch
                segmentMapping:
                  - targetSegment: logisticEventPeriod
                    fieldMapping:
                      - targetField: beginDate
                        operations:
                          - customFunction:
                              functionName: get_date_component_shipment_leg
                              fields: [ field: shipment.pickupFromDateTime ]
                      - targetField: beginTime
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_From_shipment_leg
                              fields: [ field: shipment.pickupFromDateTime,
                                          field: None,
                                          field: global_variable.payload.enrichment.dockType,
                                          field: shippingLocationCode,
                                          property: "tms_default_timezone.timezone"
                                      ]
                      - targetField: endDate
                        operations:
                          - customFunction:
                              functionName: get_date_component_shipment_leg
                              fields: [ field: shipment.pickupToDateTime ]
                      - targetField: endTime
                        operations:
                          - customFunction:
                              functionName: getTimeComponentForTL_logisticEvent_To_shipment_leg
                              fields: [ field: shipment.pickupToDateTime,
                                          field: None,
                                          field: global_variable.payload.enrichment.dockType,
                                          field: shippingLocationCode,
                                          property: "tms_default_timezone.timezone"
                                      ]
            segmentListMapping:
              - targetSegment: additionalShipmentId
                fieldMapping:
                  - targetField: typeCode
                    default: 'SHIPPER_ASSIGNED'
                  - targetField: value
                    default: '00000000000000000'
              - targetSegment: tmReferenceNumber
                sourceSegment: shipment.referenceNumberStructure
                fieldMapping:
                  - targetField: referenceNumberName
                    sourceField: referenceNumberTypeCode
                  - targetField: referenceNumberValue
                    sourceField: referenceNumber
              - targetSegment: commodityTypeCode
                fieldMapping:
                  - targetField: codeListName
                    default: 'CommodityCode'
                  - targetField: value
                    sourceField: shipment.commodityCode
              - targetSegment: shipmentItem
                sourceSegment: shipment.container
                fieldMapping:
                  - targetField: lineItemNumber
                    sourceField: systemContainerID
                segmentMapping:
                  - targetSegment: transportCargoCharacteristics
                    fieldMapping:
                      - targetField: cargoTypeCode
                        default: "12" # represent 'General Cargo'
                    segmentMapping:
                      - targetSegment: totalGrossVolume
                        fieldMapping:
                          - targetField: measurementUnitCode
                            default: 'FTQ'
                          - targetField: value
                            sourceField: containerShippingInformation.volume
                      - targetSegment: totalGrossWeight
                        fieldMapping:
                          - targetField: measurementUnitCode
                            default: 'LBR'
                          - targetField: value
                            sourceField: containerShippingInformation.nominalWeight
                segmentListMapping:
                  - targetSegment: transactionalTradeItem
                    fieldMapping:
                      - targetField: primaryId
                        operations:
                          - customFunction:
                              functionName: get_item_id_for_transactionalTradeItem_shipment_leg
                              fields: [
                                  field: transportOrderInfo.productNumberCode,
                                  field: shipmentItem.itemNumber,
                                  field: itemNumber,
                                  field: referenceNumberStructure,
                                  constant: "DCS_ITEM_ID_"
                              ]
                    segmentMapping:
                      - targetSegment: tradeItemQuantity
                        fieldMapping:
                          - targetField: value
                            sourceField: quantity
                          - targetField: measurementUnitCode
                            default: "EA"
                    segmentListMapping:
                      - targetSegment: additionalTradeItemId
                        fieldMapping:
                          - targetField: typeCode
                          - targetField: value
                            default: '00000000000000'
                  - targetSegment: transportReference
                    fieldMapping:
                      - targetField: entityId
                        operations:
                          - customFunction:
                              functionName: get_referenceNumberStructure_by_type_shipment_leg
                              fields: [field: global_variable.currentShipmentLeg.shipment.referenceNumberStructure, constant: "WM_ORDNUM_"]
                      - targetField: lineItemNumber
                        operations:
                          - customFunction:
                              functionName: get_referenceNumberStructure_by_type_shipment_leg
                              fields: [field: referenceNumberStructure, constant: "WM_ORDLIN_"]
                      - targetField: typeCode
                        default: "ON"
                      - targetField: subLineId
                        operations:
                          - customFunction:
                              functionName: get_referenceNumberStructure_by_type_shipment_leg
                              fields: [field: referenceNumberStructure, constant: "WM_ORDSLN_"]

          # this shipment mapping is for last shipment
          # leg remove when Load enrichment do not have shipment details or
          # shipment is not present in enrichment
          - targetSegment: shipment
            condition:
              customFunction:
                functionName: check_if_last_shipment_remove
                fields: [ field: enrichment.loadType.stop, field: CISDocument.ShipmentLegOriginCode]
            fieldMapping:
              - targetField: primaryId
                sourceField: CISDocument.Shipment.SystemShipmentNumber
              - targetField: logisticServiceRequirementCode
                operations:
                - function:
                    functionName: getCodemap
                    functionArguments: [ constant: "TransportServiceTransitModeFromAppToGS1", field: global_variable.payload.enrichment.loadType.serviceCode ]

            segmentMapping:
              - targetSegment: receiver
                fieldMapping:
                  - targetField: primaryId
                    sourceField: CISDocument.Shipment.CustomerCode
              - targetSegment: shipper
                fieldMapping:
                  - targetField: primaryId
                    sourceField: CISDocument.Shipment.CustomerCode
              - targetSegment: shipTo
                fieldMapping:
                  - targetField: primaryId
                    sourceField: CISDocument.Shipment.DestinationCode
              - targetSegment: shipFrom
                fieldMapping:
                  - targetField: primaryId
                    sourceField: CISDocument.Shipment.OriginCode
              - targetSegment: transportCargoCharacteristics
                fieldMapping:
                  - targetField: cargoTypeCode
                    default: "12"

#reference Number update Flow

- sourceModel: transportLoadTender
  targetModel: reference_number_update_shipment_leg
  sourceCondition:
    customFunction:
      functionName: check_shipment_leg_operation
      functionArgs: [ field: CISDocument.EventName, field: CISDocument.SystemShipmentLegID ]
  modelMapping:
    fieldVariableMapping:
      - variableName: payload
        variableValue: current_payload
    segmentListMapping:
    - targetSegment: payload
      segmentListMapping:
        - targetSegment: referenceNumberUpdateData
          condition:
            customFunction:
              functionName: check_condition_for_load_ref_update_shipment_leg
              fields: [field: enrichment.loadType.referenceNumberStructure, field: CISDocument.EventName]
          fieldMapping:
          - targetField:  referenceNumberTypeCode
            default: "WM_WH_STS_"
          - targetField:  referenceNumberEntityKey
            sourceField: enrichment.loadType.systemLoadID
          - targetField:  referenceNumberCategoryEnumVal
            default: "RNC_LD_LEG"
          - targetField:  referenceNumber
            operations:
              - customFunction:
                  functionName: get_reference_number_for_load_tl_shipment_leg
                  fields: [field: enrichment.loadType.stop, field: CISDocument.EventName]
          - targetField: referenceNumberActionEnumVal
            operations:
              - customFunction:
                  functionName: get_reference_number_action_enum_for_load_tl_shipment_leg
                  fields: [ field: CISDocument.EventName ]
          - targetField: systemReferenceNumberID
            operations:
              - customFunction:
                  functionName: get_system_reference_id_for_load_tl_shipment_leg
                  fields: [field: enrichment.loadType.referenceNumberStructure, field: CISDocument.EventName]

        - targetSegment: referenceNumberUpdateData
          sourceSegment: enrichment.loadType.stop
          condition:
              customFunction:
                functionName: check_condition_for_stop_ref_update_shipment_leg
                fields: [ field: referenceNumberStructure, field: global_variable.payload.CISDocument.EventName ]
          fieldMapping:
            - targetField: referenceNumberTypeCode
              default: "WM_SHP_STS"
            - targetField: referenceNumberEntityKey
              sourceField: systemStopID
            - targetField: referenceNumberCategoryEnumVal
              default: "RNC_STOP"
            - targetField: referenceNumber
              operations:
                - customFunction:
                    functionName: get_reference_number_for_stop_tl_shipment_leg
                    fields: [ field: shippingLocationCode , field: global_variable.payload.CISDocument.EventName]
            - targetField: referenceNumberActionEnumVal
              operations:
                - customFunction:
                    functionName: get_reference_number_action_enum_for_load_tl_shipment_leg
                    fields: [ field: global_variable.payload.CISDocument.EventName ]
            - targetField: systemReferenceNumberID
              operations:
                - customFunction:
                    functionName: get_system_reference_id_stop_load_tl_shipment_leg
                    fields: [ field: referenceNumberStructure, field: global_variable.payload.CISDocument.EventName ]